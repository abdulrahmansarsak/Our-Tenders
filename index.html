<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Tilad - بوابة المنافسات (عرض الماستر)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- مكتبة PapaParse لقراءة CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --bg-elevated: #020617;
      --card: #020617;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --danger: #f97373;
      --success: #22c55e;
      --radius: 16px;
      --shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 24px;
    }

    header h1 {
      font-size: 28px;
      margin: 0;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(56,189,248,0.08);
      color: var(--accent);
      font-size: 12px;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    @media (max-width: 900px) {
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(15,23,42,0.95);
      border-radius: var(--radius);
      border: 1px solid rgba(15,23,42,1);
      box-shadow: var(--shadow);
      padding: 16px 18px;
      backdrop-filter: blur(18px);
    }

    .card-title {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-title span {
      font-weight: 500;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .kpi {
      padding: 10px 12px;
      border-radius: 14px;
      background: radial-gradient(circle at top, rgba(56,189,248,0.15), rgba(15,23,42,1));
      border: 1px solid rgba(148,163,184,0.18);
    }

    .kpi-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 20px;
      font-weight: 600;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .filters > * {
      flex: 1 1 150px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    select, input[type="search"] {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    select:focus, input[type="search"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.5);
    }

    .stats-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 340px;
      overflow: auto;
      padding-right: 4px;
    }

    .stat-row {
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) 0.7fr 0.9fr;
      gap: 6px;
      align-items: center;
      font-size: 12px;
    }

    .stat-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stat-bar-wrap {
      position: relative;
      height: 18px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      overflow: hidden;
      border: 1px solid rgba(30,64,175,0.8);
    }

    .stat-bar {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(56,189,248,0.9), rgba(59,130,246,0.9));
      transform-origin: right center;
      transform: scaleX(0);
      transition: transform 0.25s ease-out;
    }

    .stat-bar-value {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #e5f3ff;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      font-size: 11px;
      min-width: 40px;
      text-align: center;
    }

    .table-wrapper {
      margin-top: 14px;
      border-radius: 18px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: rgba(15,23,42,0.95);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--text);
    }

    thead {
      background: radial-gradient(circle at top, rgba(56,189,248,0.12), rgba(15,23,42,1));
    }

    thead th {
      text-align: right;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.7);
    }

    tbody tr:hover {
      background: rgba(30,64,175,0.45);
    }

    td {
      padding: 7px 10px;
      border-bottom: 1px solid rgba(15,23,42,0.9);
      vertical-align: middle;
    }

    .text-muted {
      color: var(--muted);
    }

    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .export-btn {
      padding: 7px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(56,189,248,0.8), rgba(37,99,235,1));
      color: #0b1120;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .export-btn:active {
      transform: translateY(1px);
    }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="badge">
        Tilad – Business Development
      </div>
      <h1>بوابة المنافسات – عرض الماستر</h1>
      <p>
        عرض تحليلي لجميع المنافسات حسب التصنيفات، الشركات، والنطاقات – قراءة فقط.
      </p>
    </header>

    <div class="layout-grid">
      <!-- الكارد الأيسر: الفلاتر + الملخص + الجدول -->
      <section class="card">
        <div class="card-title">
          <span>مرشح النتائج</span>
        </div>

        <!-- الفلاتر -->
        <div class="filters">
          <div class="field">
            <label>التصنيف</label>
            <select id="statusFilter">
              <option value="">جميع التصنيفات</option>
            </select>
          </div>
          <div class="field">
            <label>الشركة</label>
            <select id="companyFilter">
              <option value="">جميع الشركات</option>
            </select>
          </div>
          <div class="field">
            <label>النطاق / المجال</label>
            <select id="scopeFilter">
              <option value="">جميع النطاقات</option>
            </select>
          </div>
          <div class="field">
            <label>بحث عام</label>
            <input id="searchInput" type="search" placeholder="ابحث بالاسم / الجهة / ملاحظات..." />
          </div>
        </div>

        <!-- ملخص KPIs -->
        <div class="summary-grid" id="summaryKpis">
          <!-- يمتلئ ديناميكياً -->
        </div>

        <!-- الجدول -->
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>اسم المنافسة</th>
                <th>الجهة</th>
                <th>التصنيف</th>
                <th>الشركة</th>
                <th>النطاق</th>
                <th>تاريخ إغلاق المنافسة</th>
                <th>مبلغ التقديم</th>
                <th>قيمة الترسية</th>
              </tr>
            </thead>
            <tbody id="tendersBody">
              <!-- الصفوف -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- الكارد الأيمن: الإحصاءات -->
      <section class="card">
        <div class="card-title">
          <span>إحصاءات التصنيفات</span>
          <button class="export-btn" id="exportView">
            تصدير النتائج CSV
          </button>
        </div>
        <div class="stats-list" id="statusStats">
          <!-- تعبئة ديناميكياً -->
        </div>

        <div class="card-title" style="margin-top: 12px;">
          <span>إحصاءات الشركات</span>
        </div>
        <div class="stats-list" id="companyStats">
          <!-- تعبئة ديناميكياً -->
        </div>

        <div class="card-title" style="margin-top: 12px;">
          <span>إحصاءات النطاق / المجال</span>
        </div>
        <div class="stats-list" id="scopeStats">
          <!-- تعبئة ديناميكياً -->
        </div>
      </section>
    </div>

    <div class="footer-note">
      <span>تم تطوير هذه البوابة لعرض ماستر المنافسات – إدارة المنافسات / تلاد الأعمال القابضة.</span>
      <span>إعداد: Abdulrahman Sarsak</span>
    </div>
  </div>

  <script>
    /*******************************************
     * إعدادات عامة
     *******************************************/
    // 1) رابط ملف الماستر CSV (في نفس المجلد)
    const DATA_URL = "master.csv"; // عدل الاسم أو المسار إذا رغبت

    // 2) أسماء الأعمدة داخل ملف الـ CSV (يجب أن تطابق أسماء الأعمدة في الماستر)
    const COLUMN_TENDER_NAME   = "اسم المنافسة";
    const COLUMN_CLIENT        = "الجهة";
    const COLUMN_STATUS        = "التصنيف";
    const COLUMN_COMPANY       = "الشركة";
    const COLUMN_SCOPE         = "النطاق";
    const COLUMN_DATE_CLOSE    = "تاريخ إغلاق المنافسة";
    const COLUMN_SUBMIT_AMOUNT = "مبلغ التقديم";    // اختياري – إن لم يوجد سيظهر فارغ
    const COLUMN_AWARD_VALUE   = "قيمة الترسية";    // اختياري

    // 3) قائمة التصنيفات المعتمدة (للترتيب والعرض)
    const ALL_STATUSES = [
      "فرص محتملة",
      "فرص - تم إرسال إيميل",
      "فرص انتهى وقت التقديم لها",
      "فرص - لم يتم ترشيحها",
      "تم التقديم",
      "تم التقديم - فتح العروض الفنية",
      "تم التقديم - رفض العرض الفني",
      "تم التقديم - قبول العرض الفني",
      "تم التقديم - فتح العروض المالية",
      "تم التقديم - رفض العرض المالي",
      "تم التقديم - قبول العرض المالي",
      "لن يتم التقديم",
      "لم يحن وقت التقديم",
      "لم يتم الترسية",
      "لم يتم الترسية - رفض فني",
      "تم الترسية",
      "تم الانتهاء من التعاقد",
      "الملغاة",
      "لم يتم التقديم",
      "لم يتم التقديم - لم يتم استلام العرض",
      "لم يتم التقديم - لم يتم التعميد",
      "لم يتم التقديم - لم يتم عكس الملاحظات",
      "دعوة تأهيل - لاحق",
      "دعوة التأهيل لاحق - تم التقديم",
      "دعوة التأهيل لاحق - لم يتم التقديم",
      "دعوة تأهيل المسبق",
      "دعوة تأهيل المسبق - تم التقديم",
      "دعوة تأهيل المسبق - لم يتم التقديم"
    ];

    // 4) قائمة الشركات
    const ALL_COMPANIES = [
      "البيئة",
      "البيطرة",
      "المقاولات",
      "الاستدامة",
      "المعهد",
      "السياحة",
      "حلول الأبعاد",
      "مصادر المياه",
      "تقنية المعلومات",
      "شركة المصادر",
      "شركة دروع البيانات",
      "شركة سلسال",
      "IUCN",
      "شركة الطرق الثلاث",
      "مشاركة خاصة"
    ];

    // 5) قائمة النطاق / المجال
    const ALL_SCOPES = [
      "ضمن نطاق الشركة",
      "نطاق جديد أو مختلف",
      "نطاق مشترك"
    ];

    /*******************************************
     * متغيرات
     *******************************************/
    let allRows = [];
    let filteredRows = [];

    const statusFilter  = document.getElementById("statusFilter");
    const companyFilter = document.getElementById("companyFilter");
    const scopeFilter   = document.getElementById("scopeFilter");
    const searchInput   = document.getElementById("searchInput");

    const summaryKpis   = document.getElementById("summaryKpis");
    const tendersBody   = document.getElementById("tendersBody");
    const statusStats   = document.getElementById("statusStats");
    const companyStats  = document.getElementById("companyStats");
    const scopeStats    = document.getElementById("scopeStats");
    const exportViewBtn = document.getElementById("exportView");

    /*******************************************
     * تحميل البيانات
     *******************************************/
    function loadData() {
      Papa.parse(DATA_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          allRows = results.data.map(cleanRow);
          filteredRows = [...allRows];
          initFilters();
          renderAll();
        },
        error: function(err) {
          alert("تعذر تحميل ملف الماستر: " + err.message);
        }
      });
    }

    // تنظيف الصف (ت trims بسيطة)
    function cleanRow(row) {
      const clean = {};
      for (const key in row) {
        if (!Object.prototype.hasOwnProperty.call(row, key)) continue;
        clean[key.trim()] = String(row[key]).trim();
      }
      return clean;
    }

    /*******************************************
     * الفلاتر
     *******************************************/
    function initFilters() {
      // تعبئة قيم التصنيفات
      ALL_STATUSES.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        statusFilter.appendChild(opt);
      });

      ALL_COMPANIES.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        companyFilter.appendChild(opt);
      });

      ALL_SCOPES.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        scopeFilter.appendChild(opt);
      });

      statusFilter.addEventListener("change", applyFilters);
      companyFilter.addEventListener("change", applyFilters);
      scopeFilter.addEventListener("change", applyFilters);
      searchInput.addEventListener("input", () => {
        // تأخير بسيط يمكن إضافته لو أردت
        applyFilters();
      });

      exportViewBtn.addEventListener("click", exportCurrentView);
    }

    function applyFilters() {
      const sFilter = statusFilter.value;
      const cFilter = companyFilter.value;
      const scFilter = scopeFilter.value;
      const q = searchInput.value.trim().toLowerCase();

      filteredRows = allRows.filter(row => {
        const status = row[COLUMN_STATUS] || "";
        const company = row[COLUMN_COMPANY] || "";
        const scope = row[COLUMN_SCOPE] || "";

        if (sFilter && status !== sFilter) return false;
        if (cFilter && company !== cFilter) return false;
        if (scFilter && scope !== scFilter) return false;

        if (q) {
          const combined =
            (row[COLUMN_TENDER_NAME] || "") + " " +
            (row[COLUMN_CLIENT] || "") + " " +
            (status || "") + " " +
            (company || "") + " " +
            (scope || "");
          if (!combined.toLowerCase().includes(q)) return false;
        }

        return true;
      });

      renderAll();
    }

    /*******************************************
     * عرض البيانات
     *******************************************/
    function renderAll() {
      renderSummary();
      renderTable();
      renderStats();
    }

    function renderSummary() {
      const total = filteredRows.length;
      const totalAll = allRows.length || 1;

      // إحصاء بسيط لمجموع التقديم/الترسية إن وجد
      let sumSubmit = 0;
      let sumAward  = 0;

      filteredRows.forEach(r => {
        const s = parseNumberSafe(r[COLUMN_SUBMIT_AMOUNT]);
        const a = parseNumberSafe(r[COLUMN_AWARD_VALUE]);
        sumSubmit += s;
        sumAward  += a;
      });

      summaryKpis.innerHTML = "";

      createKpi("عدد المنافسات (بعد الفلترة)", total.toLocaleString(), `من أصل ${totalAll.toLocaleString()} في الماستر`);
      createKpi("إجمالي مبلغ التقديم", sumSubmit ? formatCurrency(sumSubmit) : "—", "");
      createKpi("إجمالي قيمة الترسية", sumAward ? formatCurrency(sumAward) : "—", "");
    }

    function createKpi(label, value, sub) {
      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `
        <div class="kpi-label">${label}</div>
        <div class="kpi-value">${value}</div>
        <div class="kpi-sub">${sub || ""}</div>
      `;
      summaryKpis.appendChild(div);
    }

    function renderTable() {
      tendersBody.innerHTML = "";

      filteredRows.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(row[COLUMN_TENDER_NAME] || "")}</td>
          <td class="text-muted">${escapeHtml(row[COLUMN_CLIENT] || "")}</td>
          <td><span class="tag">${escapeHtml(row[COLUMN_STATUS] || "")}</span></td>
          <td><span class="tag">${escapeHtml(row[COLUMN_COMPANY] || "")}</span></td>
          <td><span class="tag">${escapeHtml(row[COLUMN_SCOPE] || "")}</span></td>
          <td class="text-muted">${escapeHtml(row[COLUMN_DATE_CLOSE] || "")}</td>
          <td class="text-muted">${formatMaybeCurrency(row[COLUMN_SUBMIT_AMOUNT])}</td>
          <td class="text-muted">${formatMaybeCurrency(row[COLUMN_AWARD_VALUE])}</td>
        `;
        tendersBody.appendChild(tr);
      });
    }

    function renderStats() {
      const total = filteredRows.length || 1;

      // حسب التصنيف
      const byStatus = countBy(filteredRows, COLUMN_STATUS);
      statusStats.innerHTML = "";
      ALL_STATUSES.forEach(status => {
        const count = byStatus[status] || 0;
        if (!count) return;
        const pct = (count / total) * 100;
        statusStats.appendChild(createStatRow(status, count, pct));
      });

      // حسب الشركة
      const byCompany = countBy(filteredRows, COLUMN_COMPANY);
      companyStats.innerHTML = "";
      ALL_COMPANIES.forEach(comp => {
        const count = byCompany[comp] || 0;
        if (!count) return;
        const pct = (count / total) * 100;
        companyStats.appendChild(createStatRow(comp, count, pct));
      });

      // حسب النطاق
      const byScope = countBy(filteredRows, COLUMN_SCOPE);
      scopeStats.innerHTML = "";
      ALL_SCOPES.forEach(sc => {
        const count = byScope[sc] || 0;
        if (!count) return;
        const pct = (count / total) * 100;
        scopeStats.appendChild(createStatRow(sc, count, pct));
      });
    }

    function createStatRow(label, count, pct) {
      const row = document.createElement("div");
      row.className = "stat-row";

      const pctRounded = Math.round(pct * 10) / 10;

      row.innerHTML = `
        <div class="stat-label" title="${escapeHtml(label)}">${escapeHtml(label)}</div>
        <div class="tag">${count.toLocaleString()}</div>
        <div class="stat-bar-wrap">
          <div class="stat-bar" style="transform: scaleX(${pct/100});"></div>
          <div class="stat-bar-value">${pctRounded.toFixed(1)}٪</div>
        </div>
      `;
      return row;
    }

    /*******************************************
     * تصدير النتائج الحالية CSV
     *******************************************/
    function exportCurrentView() {
      if (!filteredRows.length) {
        alert("لا توجد بيانات لتصديرها.");
        return;
      }
      const csv = Papa.unparse(filteredRows);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "Tilad_Tenders_View.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /*******************************************
     * مساعدات
     *******************************************/
    function countBy(rows, field) {
      const map = {};
      rows.forEach(r => {
        const key = (r[field] || "").trim();
        if (!key) return;
        map[key] = (map[key] || 0) + 1;
      });
      return map;
    }

    function parseNumberSafe(value) {
      if (!value) return 0;
      const cleaned = String(value).replace(/[^\d.,\-]/g, "").replace(/,/g, "");
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    }

    function formatCurrency(n) {
      return n.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " ر.س";
    }

    function formatMaybeCurrency(raw) {
      const n = parseNumberSafe(raw);
      if (!n) return "—";
      return formatCurrency(n);
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // تحميل البيانات عند فتح الصفحة
    loadData();
  </script>
</body>
</html>
